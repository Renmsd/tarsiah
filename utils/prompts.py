# RFP_SUMMARY_PROMPT (Aligned with RFP point 51)
RFP_SUMMARY_PROMPT = """
أنت خبير في المشتريات والمناقصات.  
لخص وثيقة طلب العروض (RFP) التالية إلى كائن JSON منظم.

إذا كان النص الأصلي بالعربية، فاكتب القيم **بالعربية**.  
إذا كان بالإنجليزية، فاكتبها بالإنجليزية.

المطلوب تضمين المفاتيح التالية:
- "project_scope": وصف موجز للمشروع (الغرض من المنافسة، مثلاً: تأمين التصريح البيئي ...). إذا لم يكن هناك وصف محدد، اذكر أن هذا نموذج عام.
- "technical_requirements": قائمة **محددة** بالمتطلبات الفنية الأساسية إذا وُجدت في النص. إذا كان النص يشير إلى أقسام أو مرفقات مفصلة، اذكر ذلك. (مثلاً: "التفاصيل حسب القسم السابع: نطاق العمل المفصل - لا يوجد")
- "evaluation_criteria_details": **كائن** يحتوي على تفاصيل معايير التقييم المذكورة صراحة في النص، وفقًا للمعلومات التالية:
  - الحد الأدنى للنجاح في التقييم الفني: 70 نقطة.
  - معايير التقييم الفني:
    - "القدرات الفنية (إدارة مرافق)": 30 نقطة
    - "الخبرات السابقة في مجال عمل مشابه": 20 نقطة
    - "قدرات الفريق الفني": 20 نقطة
    - "خطة إدارة المشروع": 20 نقطة
    - "خطة إدارة المخاطر ومدة الاستجابة للمشاكل التقنية": 10 نقاط
  - التقييم المالي: يتم الترسية على العرض الأقل سعراً من بين العروض التي اجتازت التقييم الفني.
  (مثلاً: {{"technical_pass_mark": 70, "technical_criteria": [{{"name": "القدرات الفنية (إدارة مرافق)", "weight": 30}}, {{"name": "الخبرات.previous_experience_in_similar_field", "weight": 20}}, ...], "financial_evaluation_method": "lowest_price_among_qualified"}}). لا تخترع معايير.
- "submission_deadline": التاريخ المحدد لتقديم العروض (إذا وُجد)
- "contact_info": معلومات الاتصال (البريد الإلكتروني، الهاتف، الاسم إن وُجد)

**ملاحظة مهمة:** إذا كان النص يحتوي على أقسام تشير إلى أن التفاصيل موضحة في مرفقات أو أقسام أخرى (مثلاً: "حسب المرفق"، "لا يوجد"، "حسب نظام المشتريات الحكومي")، فاذكر ذلك في الحقول المقابلة بدلاً من تركها فارغة أو محاولة تخمين محتواها.

نص وثيقة طلب العروض:
{rfp_text}

أجب **بـ JSON صالح فقط**. لا تستخدم تنسيق Markdown أو شرح خارجي.
"""

# EVALUATION_PROMPT (Updated to align with RFP point 51 criteria)
EVALUATION_PROMPT = """
أنت خبير تقييم مناقصات. قم بتقييم العرض المقدم مقابل متطلبات كراسة الشروط التالية، مع التركيز على معايير تقييم العروض المذكورة في **القسم الخامس، نقطة 51**.

**ملخص متطلبات كراسة الشروط:**
{rfp_summary}

**نص العرض المقدم:**
{proposal_text}

**المعايير المطلوب التقييم عليها (من كراسة الشروط، نقطة 51):**
{criteria_list}

**التعليمات:**
- قم بتقييم العرض المقدم بناءً على **الcriteria_list** التالية، وهي معايير التقييم الفني المذكورة أعلاه.
- منح **درجة من 0 إلى 100** لكل معيار من معايير التقييم الفني (مثلاً، درجة من 0-100 لـ "القدرات الفنية (إدارة مرافق)"). يجب أن تعكس الدرجة مدى توافق العرض مع متطلبات هذا المعيار المحدد.
- اذكر **إذا ما كان العرض قد نجح في التقييم الفني** (أي هل مجموع درجاته >= 70 نقطة).
- اذكر **مدى ملاءمة سعر العرض** بشكل عام (مثلاً: منخفض، متوسط، مرتفع) مقارنة بما هو متوقع أو مذكور في كراسة الشروط (إن وُجد).
- **أعد الاستجابة فقط كـ JSON نقي، بدون أي نصوص إضافية أو تنسيق مثل ```markdown**.
- يجب أن يحتوي JSON على مفتاحين فقط: "scores" (وهو كائن يحتوي على المعايير ودرجاتها *ال Maximale 100*، وليس المجموع الموزون النهائي)، و "overall_comment".

**ملاحظة:** لا تقم بتقييم السعر ضمن معايير "scores" هنا، لأن التقييم المالي يتم لاحقاً بعد اجتياز التقييم الفني. ركّز فقط على الجوانب الفنية حسب المعايير المذكورة.

**مثال على التنسيق المطلوب ((scores يحتوي على الدرجات من 0-100 لكل معيار فني فقط)):**
{{"scores": {{"القدرات الفنية (إدارة مرافق)": 85, "الخبرات.previous_experience_in_similar_field": 90, "قدرات الفريق الفني": 75, "خطة إدارة المشروع": 80, "خطة إدارة المخاطر ومدة الاستجابة للمشاكل التقنية": 70}}, "overall_comment": "العرض يحقق متطلبات المعايير الفنية بشكل جيد. مجموع الدرجات هو 400 من أصل 500، مما يعادل X.X نقطة من 70. يجتاز التقييم الفني. السعر معقول."}}
"""

# RANKING_PROMPT (Refined to reflect RFP logic)
RANKING_PROMPT = """
لقد تم تقييم العروض المقدمة.  
إذا كانت البيانات بالعربية، فاكتب النتيجة **بالعربية**.

**مهمة الترتيب:**
- قم بترتيب العروض من **الأفضل إلى الأسوأ** بناءً على تقييم شامل.
- **القاعدة الأساسية:** يجب أن تفوز **أقل تكلفة / سعر** من بين العروض التي **اجتازت التقييم الفني (تحصل على 70 نقطة فنيًا على الأقل)**.
- إذا حصلت عروض متعددة على 70 نقطة فنيًا أو أكثر، رتبها حسب **السعر (الأقل أولوية)**.
- **في حالة تساوي السعر بين عروض مؤهلة فنيًا،** اعتبر **المجموع الكلي للتقدير الفني** (الذي تم حسابه باستخدام الأوزان: 30، 20، 20، 20، 10) كمقياس فرز ثانوي.
- خذ بعين الاعتبار **التعليقات العامة** لتحديد جودة التوافق مع متطلبات كراسة الشروط.

**العروض المقيّمة:**
{scored_proposals}

**التعليمات:**
- أعد استجابتك **كـ JSON صالح فقط، بدون أي تنسيق إضافي، بدون علامات مثل ``` أو شرح خارجي**.
- يجب أن يحتوي الاستجابة على:
  - "ranked_ids": قائمة بمعرّفات العروض مرتبة (الأفضل أولاً). يجب أن يحتوي المعيار الأول على أقل سعر من بين العروض المؤهلة فنيًا.
  - "rationale": تبرير موجز للترتيب، موضحًا أن العروض تم ترتيبها حسب السعر من بين من اجتازوا التقييم الفني، وربما مقارنة المجموع الفني في حالة التساوي بالسعر.

**مثال صحيح:**
{{"ranked_ids": ["prop_3", "prop_1", "prop_2"], "rationale": "العرض prop_3 حصل على أقل سعر من بين العروض التي اجتازت التقييم الفني (مثلاً، حصل على 75 نقطة فنيًا). العرض prop_1 احتل المركز الثاني بسعر أعلى قليلاً (72 نقطة فنية). العرض prop_2 حصل على ترتيب أعلى قليلاً من prop_4 رغم تساوي السعر لأن مجموع تقديره الفني كان أعلى."}}
"""

EXTRACT_REQUIREMENTS_PROMPT = """
أنت خبير في تحليل كراسات الشروط والمواصفات الحكومية السعودية.

مهمتك هي تحليل نص كراسة الشروط التالية واستخلاص **المتطلبات الأساسية** المطلوبة من الموردين لتقديم عروضهم.

**تعليمات التحليل:**
1.  ركّز على الأقسام التي تحدد **ما يجب على المورد تقديمه** (نطاق العمل، المتطلبات الفنية، الشروط، المعايير).
2.  تجاهل الأقسام القانونية العامة أو الإجرائية التي لا تتعلق مباشرة بمتطلبات العرض.
3.  حاول استخلاص متطلبات محددة قابلة للتقييم (مثل: نوع النظام، المدة، الميزانية، الشهادات، الخبرة المطلوبة).
4.  إذا وُجدت معايير تقييم رسمية في الكراسة، اذكرها.
5.  إذا وُجدت معلومات عن الجدول الزمني أو الميزانية، استخرجها.
6.  إذا وُجدت معلومات عن جهة الاتصال، استخرجها.

**النص المراد تحليله:**
{rfp_text}

**النتيجة المطلوبة:**
أعد استجابتك **كـ JSON نقي فقط**، بدون أي نصوص إضافية أو تنسيق مثل ```markdown.

يجب أن يحتوي JSON على المفاتيح التالية (املأها حسب المتوفر في النص، إذا لم يوجد اتركها فارغة أو كقائمة فارغة):
- "project_scope": وصف عام لهدف المشروع أو نوع النظام المطلوب.
- "technical_requirements": قائمة بالمتطلبات الفنية المحددة (مثل: التكامل مع أنظمة معينة، معايير أمنية، واجهة مستخدم، إلخ).
- "functional_requirements": قائمة بالوظائف أو الخدمات المطلوبة (مثل: إدارة المرضى، إدارة الأدوية، تقارير، إلخ).
- "delivery_timeline_months": مدة التنفيذ المطلوبة (رقم فقط، مثلاً 8).
- "budget_limit_sar": الحد الأقصى للميزانية (رقم فقط، مثلاً 2000000).
- "experience_requirements": متطلبات الخبرة (مثل: خبرة في القطاع الصحي، مشاريع مماثلة).
- "evaluation_criteria": قائمة بمعايير التقييم الرسمية المذكورة في الكراسة (مثل: السعر، الخبرة، الجدول الزمني).
- "mandatory_certifications": قائمة بالشهادات أو المتطلبات الإلزامية (مثل: ISO 27001).
- "contact_information": معلومات الاتصال (البريد الإلكتروني، الهاتف، الاسم إن وُجد).
- "submission_deadline": آخر موعد لتقديم العروض (إن وُجد).
"""

# NEW: Focus Window Prompt for Enhanced Criteria Extraction
FOCUS_WINDOW_PROMPT = """
أنت خبير في تحليل كراسات الشروط (RFP).
المُدخل التالي هو **القسم الخاص بالمعايير وتقييم العروض فقط** كما قُصّ من الوثيقة. لا تستخدم أي نص خارج هذا القسم.
المطلوب: استخراج **معايير التقييم فقط** (فنية ومالية) التي لها وزن (percent/points) وتدخل في الحساب.
- أمثلة فنية شائعة: عدد المشاريع، إجمالي قيّم المشاريع، سنوات الخبرة، التصاميم المبدئية، الخطة الزمنية للتنفيذ والتشغيل.
- أمثلة مالية شائعة: رأس المال، نسبة السيولة، نسبة الربحية، نسبة المديونية.
- تجاهل تمامًا البنود التالية (ليست معايير تقييم): الشروط/الالتزامات/المتطلبات/الوثائق/الضمان/الضرائب/السلامة/الصيانة/مدد العقد أو التجهيز.
- إن وُجدت نسبة اجتياز فني (مثل 70%) فضعها في technical_passing_score.
- إن وُجدت آلية الترسية بعد الاجتياز الفني فضعها في financial_rule (مثلاً: اختيار أعلى عرض مالي).
- إن وُجد توزيع إجمالي (مثل 70% فني / 30% مالي) فضعه في overall_mix.
أعد فقط JSON بالهيكل: technical_passing_score, technical_criteria[], financial_criteria[], financial_rule, overall_mix.
لا تختلق معلومات. evidence قصير يذكر من أين أُخذ داخل هذا القسم.

[نص المقطع #{chunk_num}/{total_chunks}]
{chunk_text}
"""